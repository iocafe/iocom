# parameters_to_c.py 11.6.2020/pekka
# Convert parameter JSON file to C code.
import json
import os
import sys

def start_c_files():
    global cfile, hfile, cfilepath, hfilepath
    cfile = open(cfilepath, "w")
    hfile = open(hfilepath, "w")
    cfile.write('/* This file is generated by parameters_to_c.py script, do not modify. */\n')
    hfile.write('/* This file is generated by parameters_to_c.py script, do not modify. */\n')
    path, fname = os.path.split(hfilepath)
    fname, ext = os.path.splitext(fname)
    macroname = 'IOC_' + fname.upper() + '_INCLUDED'
    hfile.write('#ifndef ' + macroname + '\n')
    hfile.write('#define ' + macroname + '\n')
    hfile.write('OSAL_C_HEADER_BEGINS\n\n')

def finish_c_files():
    global cfile, hfile
    hfile.write('\nOSAL_C_HEADER_ENDS\n')
    hfile.write('#endif\n')
    cfile.close()
    hfile.close()

def setup_group(x_groups, group_name):
    for group in x_groups:
        if group_name == group.get("name", None):
            return group["signals"]

    group = {"name" : group_name, "signals" : []} 
    x_groups.append(group)
    return group["signals"]

'''
def append_persistent_parameter_to_h(parameter):
    global current_type;

    name = parameter.get("name", None);
    if name == None:
        print("Parameter without name");
        return

    type = parameter.get("type", None);
    if type != None:
        current_type = type

    array_n = parameter.get('array', 1);
    if array_n < 1:
        array_n = 1

    if current_type == 'str':
        ctype = 'char'
    else:
        ctype = current_type
    hfile.write('  os_' + ctype + ' ' + name)

    if array_n > 1:
        hfile.write('[' + str(array_n) + ']')

    hfile.write(';\n')

    init = parameter.get('init', None);

    if init != None:
        if array_n > 1:
            if type == 'str':
                cfile.write('"' + str(init) + '"')
            else:
                init_list = init.split(',')
                is_first = True
                cfile.write('{')
                for i in init_list:
                    if not is_first:
                        cfile.write(', ')
                    is_first = False
                    cfile.write(str(i))
                cfile.write('{')
        else:
            cfile.write(str(init))

    cfile.write(' /* ' + name + ' */')
'''

def append_init_parameter_to_c(parameter):
    global current_type, device_name;

    init = parameter.get('init', None);
    if init == None:
        return;

    name = parameter.get("name", None);
    if name == None:
        print("Parameter without name");
        return

    type = parameter.get("type", None);
    if type != None:
        current_type = type

    array_n = parameter.get('array', 1);

    cfile.write('  ')

    if array_n > 1:
        if type == 'str':
            cfile.write('ioc_set_str(&' + device_name + '.exp.' + name + ', "' + str(init) + '");\n')
        else:
            cfile.write('static OS_FLASH_MEM os_' + type + ' ioc_idata_' + name + '[] = {')
            init_list = init.split(',')
            is_first = True
            for i in init_list:
                if not is_first:
                    cfile.write(', ')
                is_first = False
                cfile.write(str(i))
            cfile.write('};\n  ')
            cfile.write('ioc_set_array(&' + device_name + '.exp.' + name + ', ' + 'ioc_idata_' + name + ');\n')
    else:
        cfile.write('ioc_set(&' + device_name + '.exp.' + name + ', ' + str(init) + ');\n')
    
def process_struct(step, data, struct_name, global_name):
    global current_type

    is_first = True
    current_type = "ushort"
    title = data.get("title", "untitled")
    groups = data.get("groups", None)
    if groups == None:
        print('"' + title + '" is empty?')
        return


    for group in groups:
        parameters = group.get("parameters", None)
        if parameters == None:
            print("Group without parameters?")
        elif step == 'init':
            for parameter in parameters:
                append_init_parameter_to_c(parameter);

        '''
        elif step == 'init':
            for parameter in parameters:
                if not is_first:
                    cfile.write(',\n  ')
                is_first = False
                append_parameter(parameter)
        '''

def process_source_data(step, sourcedata):
    for data in sourcedata:
        persistent = data.get("persistent", None)
        if persistent != None:
            process_struct(step, persistent, "iocDevicePersistentPrm", "ioc_persistent_prm")

        if step == 'init':
            volatile = data.get("volatile", None)
            if volatile != None:
                process_struct(step, volatile, "iocDeviceVolatilePrm", "ioc_volatile_prm")

def load_source_file(path):
    global device_name
    read_file = open(path, "r")
    if read_file:
        data = json.load(read_file)

        if device_name == None:
            device_name = data.get("name", "NONAME")
    return data;

def mymain():
    global cfilepath, hfilepath, device_name
    n = len(sys.argv)
    sourcefiles = []
    outpath = None
    expect = None
    device_name = None
    for i in range(1, n):
        if sys.argv[i][0] == "-":
            if sys.argv[i][1] == "o":
                expect = 'o'
        else:
            if expect=='o':
                outpath = sys.argv[i]
                expect = None
            else:
                sourcefiles.append(sys.argv[i])

    if len(sourcefiles) < 1:
        print("No source files")
        exit()
        # sourcefiles.append('/coderoot/iocom/examples/candy/config/parameters/parameters.json')

    if outpath is None:
        outpath = sourcefiles[0]

    filename, file_extension = os.path.splitext(outpath)
    cfilepath = filename + '.c'
    hfilepath = filename + '.h'

    # Make sure that "intermediate" directory exists.
    dir_path, file_name =  os.path.split(outpath)
    try:
        os.makedirs(dir_path)
    except FileExistsError:
        pass

    sourcedata = []
    for path in sourcefiles:
        data = load_source_file(path)
        sourcedata.append(data)

    print("Writing files " + cfilepath + " and " + hfilepath)

    start_c_files()

    # Write initialization structure  save function
    # hfile.write('typedef struct iocDevicePersistentPrm {\n')
    # process_source_data('struct', sourcedata)
    # hfile.write('};\n\n')

    # Write initialization function
    cfile.write('void ioc_initialize_parameters(os_int block_nr)\n{\n')
    cfile.write('  os_memclear(&ioc_prm_storage, sizeof(ioc_prm_storage));\n')
    cfile.write('  ioc_prm_storage.block_nr = block_nr;\n')
    process_source_data('init', sourcedata)
    cfile.write('};\n\n')

    # Write persistent load function
    cfile.write('osalStatus ioc_load_parameters(void)\n{\n')
    process_source_data('load', sourcedata)
    cfile.write('  return OSAL_SUCCESS;\n')
    cfile.write('};\n\n')

    # Write persistent save function
    cfile.write('osalStatus ioc_save_parameters(void)\n{\n')
    process_source_data('save', sourcedata)
    cfile.write('  return OSAL_SUCCESS;\n')
    cfile.write('};\n\n')
    # SET CHANGED BIT OFF

    # Write autosave function
    cfile.write('osalStatus ioc_autosave_parameters(void)\n{\n')
    cfile.write('  if (ioc_prm_storage.changed) {\n')
    cfile.write('    if (os_has_elapsed(&ioc_prm_storage.ti, 10000)) {\n')
    cfile.write('       ioc_save_parameters();\n')
    cfile.write('    }\n')
    cfile.write('  }\n')
    cfile.write('  return OSAL_SUCCESS;\n')
    cfile.write('};\n\n')

    # Write heade file
    hfile.write('void ioc_initialize_parameters(os_int block_nr);\n')
    hfile.write('osalStatus ioc_load_parameters(void);\n')
    hfile.write('osalStatus ioc_save_parameters(void);\n')
    hfile.write('osalStatus ioc_autosave_parameters(void);\n')

    finish_c_files()

mymain()
